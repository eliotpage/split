<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Persistent Leaflet Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet-draw/leaflet.draw.css') }}">

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100%; height:100%; }

/* Text marker styling */
.text-marker {
    display: inline-block;
    min-width: 50px;
    max-width: 220px;
    font-size: 16px;
    font-weight: bold;
    color: red;
    background-color: white;
    padding: 2px 6px;
    border-radius: 3px;
    border: 1px solid #999;
    text-align: center;
    pointer-events: none;
    position: relative;
    white-space: normal;
    word-break: break-word;
    line-height: 1.2em;
}
.text-marker::after {
    content: "";
    position: absolute;
    left: 50%;
    bottom: -6px;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid black;
}

/* Text Marker toolbar button */
.leaflet-draw-draw-textmarker {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 30px;
    height: 30px;
    background-color: white;
    border: 1px solid #999;
    border-radius: 4px;
    font-weight: bold;
    font-size: 16px;
    color: black !important;
    cursor: pointer;
    text-decoration: none;
}
.leaflet-draw-draw-textmarker:hover {
    background-color: #f4f4f4;
    border-color: #666;
}
</style>
</head>
<body>
<div id="map"></div>

<script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
<script src="{{ url_for('static', filename='leaflet-draw/leaflet.draw.js') }}"></script>

<script>
var map = L.map('map').setView([0,0], 2);
L.tileLayer('/static/tiles/{z}/{x}/{y}.png', {maxZoom:4,tileSize:256, attribution:'Placeholder tiles'}).addTo(map);

var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon:true, polyline:true, rectangle:true, circle:true, marker:true }
});
map.addControl(drawControl);

// Place text marker helper
function placeTextMarker(latlng, text){
    var icon = L.divIcon({className:'text-marker', html:text, iconSize:null, iconAnchor:[50,25]});
    var marker = L.marker(latlng,{icon:icon});
    drawnItems.addLayer(marker);
    return marker;
}

// Save shape to server
function saveShape(data){
    fetch("/add_shape",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
}

// Convert shapes to proper GeoJSON for polygons, polylines, rectangles
function shapeToGeoJSON(layer, layerType){
    let geojson = layer.toGeoJSON();
    geojson.type = "Feature";
    geojson.properties = { layerType: layerType };
    return geojson;
}

// Load saved shapes
fetch("/get_shapes").then(r=>r.json()).then(data=>{
    data.forEach(item=>{
        if(item.type === "textmarker") {
            placeTextMarker(item.latlng, item.text);
        } else if(item.type === "marker") {
            L.marker(item.latlng).addTo(drawnItems);
        } else if(item.type === "circle") {
            // recreate circle with saved radius
            L.circle(item.latlng, {radius:item.radius}).addTo(drawnItems);
        } else if(item.type === "circlemarker") {
            L.circleMarker(item.latlng, {radius:item.radius}).addTo(drawnItems);
        } else if(item.type === "Feature") {
            try { L.geoJSON(item).eachLayer(layer => drawnItems.addLayer(layer)); }
            catch(err){ console.error("Invalid GeoJSON:", item, err); }
        }
    });
});

// Handle created shapes
map.on(L.Draw.Event.CREATED,function(event){
    var layer = event.layer;
    drawnItems.addLayer(layer);

    let shapeData;

    if(event.layerType === "marker") {
        shapeData = {type:"marker", latlng:layer.getLatLng()};
    } else if(event.layerType === "textmarker") {
        shapeData = {type:"textmarker", latlng:layer.getLatLng(), text:layer.getElement().innerHTML};
    } else if(event.layerType === "circle") {
        shapeData = {type:"circle", latlng:layer.getLatLng(), radius:layer.getRadius()};
    } else if(event.layerType === "circlemarker") {
        shapeData = {type:"circlemarker", latlng:layer.getLatLng(), radius:layer.getRadius()};
    } else {
        shapeData = shapeToGeoJSON(layer,event.layerType);
    }

    saveShape(shapeData);
});

// Text Marker button
var container = drawControl._container;
var circleBtn = container.querySelector('.leaflet-draw-draw-circle');
var circleGroup = circleBtn.closest('.leaflet-draw-section');

var textButton = L.DomUtil.create('a','leaflet-draw-draw-marker leaflet-draw-draw-textmarker',circleGroup);
textButton.href="#"; textButton.title="Text Marker"; textButton.innerHTML="T";

L.DomEvent.on(textButton,'click',function(e){
    L.DomEvent.stopPropagation(e); L.DomEvent.preventDefault(e);

    var text = prompt("Enter text to place on the map:");
    if(!text) return;

    var previewIcon = L.divIcon({className:'text-marker', html:text, iconSize:null, iconAnchor:[50,25]});
    var previewMarker = L.marker(map.getCenter(),{icon:previewIcon, interactive:false}).addTo(map);

    function onMouseMove(ev){ previewMarker.setLatLng(ev.latlng); }
    map.on('mousemove',onMouseMove);

    function onMapClick(ev){
        previewMarker.remove();
        map.off('mousemove',onMouseMove);
        map.off('click',onMapClick);

        placeTextMarker(ev.latlng,text);
        saveShape({type:"textmarker", latlng:ev.latlng, text:text});
    }
    map.once('click',onMapClick);
});
</script>
</body>
</html>
